.............................Fs....                                      [100%]
================================== FAILURES ===================================
________________ test_terminfo_fallback_sets_env_and_recovers _________________

args = (), kwargs = {}

    def fake_setupterm(*args, **kwargs):
        calls["count"] += 1
        # First two attempts fail; third succeeds
        if calls["count"] < 3:
>           raise Exception("no terminfo")
E           Exception: no terminfo

modules\termdash\tests\terminfo_fallback_test.py:26: Exception

During handling of the above exception, another exception occurred:

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x000002308BFC79B0>

    def test_terminfo_fallback_sets_env_and_recovers(monkeypatch):
        # Ensure stdio looks like a TTY
        monkeypatch.setattr("sys.stdin.isatty", lambda: True)
        monkeypatch.setattr("sys.stdout.isatty", lambda: True)
    
        calls = {"count": 0}
    
        real_setupterm = curses.setupterm
    
        def fake_setupterm(*args, **kwargs):
            calls["count"] += 1
            # First two attempts fail; third succeeds
            if calls["count"] < 3:
                raise Exception("no terminfo")
            return real_setupterm(*args, **kwargs)
    
        monkeypatch.setattr(curses, "setupterm", fake_setupterm)
    
        # Pick a known-good TERM
        monkeypatch.setenv("TERM", "xterm-256color")
        # Clear TERMINFO_DIRS to let fallback set it
        if "TERMINFO_DIRS" in os.environ:
            monkeypatch.delenv("TERMINFO_DIRS", raising=False)
    
        # Create a minimal InteractiveList (won't run the UI in this test)
        il = InteractiveList(items=[], sorters={"name": lambda x: x}, formatter=lambda *a, **k: "", filter_func=lambda i, p: True)
    
        # Call the readiness check directly; it should attempt TERMINFO_DIRS fallback and not raise
>       il._ensure_terminal_ready()

modules\termdash\tests\terminfo_fallback_test.py:41: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <termdash.interactive_list.InteractiveList object at 0x000002308BF97110>

    def _ensure_terminal_ready(self) -> None:
        """Validate that a TTY and terminfo database are available.
    
        This is stricter than a mere 'curses' import: it checks that stdin/stdout
        are TTYs and that the terminfo database can be initialized. It avoids
        running `curses.wrapper(...)` only to crash with a cryptic error.
        """
        # Ensure we are attached to an interactive terminal.
        if not (sys.stdin.isatty() and sys.stdout.isatty()):
            sys.stderr.write(
                "An interactive terminal (TTY) is required for the TUI.\n"
                "Run this command directly in a terminal, or use a non-TUI mode (e.g., --json).\n"
            )
            raise SystemExit(2)
    
        # Attempt to initialize terminfo if supported by the platform.
        # Some Windows curses builds might not expose setupterm; guard accordingly.
        if hasattr(curses, "setupterm"):
            try:
                curses.setupterm()
            except Exception as e:  # pragma: no cover - platform dependent
                # Try safe fallbacks for TERM if a specific entry is missing.
                current_term = os.environ.get("TERM", "unknown")
                for fallback_term in ("xterm-256color", "screen-256color"):
                    if current_term == fallback_term:
                        continue
                    try:
                        os.environ["TERM"] = fallback_term
                        curses.setupterm()
                        sys.stderr.write(
                            f"Warning: TERM={current_term} failed; using TERM={fallback_term} as a fallback.\n"
                        )
                        break
                    except Exception:
                        continue
                else:
                    # No TERM fallback worked — try to set TERMINFO_DIRS to common locations and retry.
                    candidates = [
                        "/usr/share/terminfo",
                        "/lib/terminfo",
                        "/usr/lib/terminfo",
                        "/data/data/com.termux/files/usr/share/terminfo",
                    ]
                    existing = os.environ.get("TERMINFO_DIRS", "")
                    probe_dirs = [d for d in candidates if os.path.isdir(d)]
                    if probe_dirs:
                        merged = ":".join([p for p in [existing] if p] + probe_dirs)
                        os.environ["TERMINFO_DIRS"] = merged
                        try:
                            curses.setupterm()
                            sys.stderr.write(
                                f"Warning: terminfo database not found initially; set TERMINFO_DIRS={merged} and continued.\n"
                            )
                            return
                        except Exception:
                            pass
                    # Still failing — provide actionable guidance and exit.
                    term = current_term
                    sys.stderr.write(
                        "Unable to initialize terminal capabilities (terminfo).\n"
                        f"TERM={term}. Error: {e}\n"
                        "Install the terminfo database for your system. Examples:\n"
                        "  - Debian/Ubuntu: sudo apt-get install ncurses-term\n"
                        "  - Fedora:        sudo dnf install ncurses-term\n"
                        "  - Arch:          sudo pacman -S ncurses\n"
                        "  - Termux:        pkg install ncurses\n"
                        "Alternatively, export TERMINFO_DIRS to the correct terminfo path.\n"
                        "Then re-run this command, or use a non-TUI mode (e.g., --json).\n"
                    )
>                   raise SystemExit(2)
E                   SystemExit: 2

modules\termdash\interactive_list.py:294: SystemExit
---------------------------- Captured stderr call -----------------------------
Unable to initialize terminal capabilities (terminfo).
TERM=xterm-256color. Error: no terminfo
Install the terminfo database for your system. Examples:
  - Debian/Ubuntu: sudo apt-get install ncurses-term
  - Fedora:        sudo dnf install ncurses-term
  - Arch:          sudo pacman -S ncurses
  - Termux:        pkg install ncurses
Alternatively, export TERMINFO_DIRS to the correct terminfo path.
Then re-run this command, or use a non-TUI mode (e.g., --json).
=========================== short test summary info ===========================
FAILED modules\termdash\tests\terminfo_fallback_test.py::test_terminfo_fallback_sets_env_and_recovers
1 failed, 33 passed, 1 skipped in 0.21s
